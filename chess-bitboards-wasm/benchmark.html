<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM vs JS Benchmark</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 1000px; margin: 0 auto; background: #f5f5f5; }
        h1 { color: #333; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .wasm { border-left-color: #28a745; }
        .js { border-left-color: #ffc107; }
        .winner { background: #d4edda; border-left-color: #28a745; font-weight: bold; }
        .slower { background: #fff3cd; border-left-color: #ffc107; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #007bff; color: white; }
        .speedup { color: #28a745; font-weight: bold; }
        .slowdown { color: #dc3545; font-weight: bold; }
        #output { white-space: pre-wrap; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ WASM vs JavaScript Benchmark</h1>
        <p>Comparing chess bitboard operations: Rust/WASM vs Pure JavaScript</p>
        
        <div>
            <button id="quickBtn">Quick Benchmark (100k ops)</button>
            <button id="fullBtn">Full Benchmark (1M ops)</button>
            <button id="intensiveBtn">Intensive (10M ops)</button>
        </div>
        
        <div id="output">Loading WASM module...</div>
    </div>

    <script type="module">
        import init, { 
            popcount64, 
            lsb64, 
            msb64,
            knight_attacks,
            king_attacks,
            rook_attacks,
            bishop_attacks
        } from './pkg/chess_bitboards_wasm.js';

        const output = document.getElementById('output');
        
        function log(html) {
            output.innerHTML += html;
        }

        function clear() {
            output.innerHTML = '';
        }

        // JavaScript implementations for comparison
        function js_popcount(n) {
            let count = 0;
            while (n > 0n) {
                count++;
                n &= n - 1n;
            }
            return count;
        }

        function js_lsb(n) {
            if (n === 0n) return -1;
            let pos = 0;
            while ((n & 1n) === 0n) {
                n >>= 1n;
                pos++;
            }
            return pos;
        }

        // Initialize WASM
        try {
            await init();
            clear();
            log('<div class="result">‚úÖ WASM module loaded successfully</div>');
            
            // Enable buttons
            document.getElementById('quickBtn').disabled = false;
            document.getElementById('fullBtn').disabled = false;
            document.getElementById('intensiveBtn').disabled = false;
        } catch (error) {
            clear();
            log(`<div class="result error">‚ùå Error loading WASM: ${error.message}</div>`);
            log('<div class="result error">Make sure pkg/ directory exists with compiled WASM</div>');
        }
        
        // Attach event listeners
        document.getElementById('quickBtn').addEventListener('click', () => runBenchmark(100000));
        document.getElementById('fullBtn').addEventListener('click', () => runBenchmark(1000000));
        document.getElementById('intensiveBtn').addEventListener('click', () => runBenchmark(10000000));

        function runBenchmark(iterations) {
            clear();
            log(`<h2>üèÅ Benchmark Results (${iterations.toLocaleString()} iterations)</h2>`);
            
            // Use variable values to prevent compiler optimizations
            const testValues = [
                0x123456789ABCDEFn,
                0xFEDCBA987654321n,
                0xAAAAAAAAAAAAAAAAn,
                0x5555555555555555n
            ];
            const square = 28; // e4
            const occupancy = 0xFFFF00000000FFFFn; // All pieces on ranks 1,2,7,8
            
            // Popcount Benchmark
            log('<div class="result js">');
            log('<strong>JavaScript - Popcount</strong><br>');
            let start = performance.now();
            for (let i = 0; i < iterations; i++) {
                js_popcount(testValues[i % 4]);
            }
            const jsPopcountTime = performance.now() - start;
            log(`Time: ${jsPopcountTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / jsPopcountTime * 1000).toLocaleString()}</div>`);
            
            log('<div class="result wasm">');
            log('<strong>WASM - Popcount</strong><br>');
            start = performance.now();
            for (let i = 0; i < iterations; i++) {
                popcount64(testValues[i % 4]);
            }
            const wasmPopcountTime = performance.now() - start;
            log(`Time: ${wasmPopcountTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / wasmPopcountTime * 1000).toLocaleString()}</div>`);
            
            const popcountSpeedup = (jsPopcountTime / wasmPopcountTime).toFixed(2);
            if (popcountSpeedup >= 1) {
                log(`<div class="result winner">üèÜ WASM is ${popcountSpeedup}x faster</div>`);
            } else {
                log(`<div class="result slower">‚ö†Ô∏è JS is ${(1/popcountSpeedup).toFixed(2)}x faster (WASM overhead)</div>`);
            }
            
            // LSB Benchmark
            log('<div class="result js">');
            log('<strong>JavaScript - LSB (Least Significant Bit)</strong><br>');
            start = performance.now();
            for (let i = 0; i < iterations; i++) {
                js_lsb(testValues[i % 4]);
            }
            const jsLsbTime = performance.now() - start;
            log(`Time: ${jsLsbTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / jsLsbTime * 1000).toLocaleString()}</div>`);
            
            log('<div class="result wasm">');
            log('<strong>WASM - LSB</strong><br>');
            start = performance.now();
            for (let i = 0; i < iterations; i++) {
                lsb64(testValues[i % 4]);
            }
            const wasmLsbTime = performance.now() - start;
            log(`Time: ${wasmLsbTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / wasmLsbTime * 1000).toLocaleString()}</div>`);
            
            const lsbSpeedup = (jsLsbTime / wasmLsbTime).toFixed(2);
            if (lsbSpeedup >= 1) {
                log(`<div class="result winner">üèÜ WASM is ${lsbSpeedup}x faster</div>`);
            } else {
                log(`<div class="result slower">‚ö†Ô∏è JS is ${(1/lsbSpeedup).toFixed(2)}x faster (WASM call overhead)</div>`);
            }
            
            // Knight Attacks (WASM only - no JS comparison needed)
            log('<div class="result wasm">');
            log('<strong>WASM - Knight Attacks</strong><br>');
            start = performance.now();
            for (let i = 0; i < iterations; i++) {
                knight_attacks(square);
            }
            const wasmKnightTime = performance.now() - start;
            log(`Time: ${wasmKnightTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / wasmKnightTime * 1000).toLocaleString()}</div>`);
            
            // Rook Attacks
            log('<div class="result wasm">');
            log('<strong>WASM - Rook Attacks (with occupancy)</strong><br>');
            start = performance.now();
            for (let i = 0; i < iterations; i++) {
                rook_attacks(square, occupancy);
            }
            const wasmRookTime = performance.now() - start;
            log(`Time: ${wasmRookTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / wasmRookTime * 1000).toLocaleString()}</div>`);
            
            // Bishop Attacks
            log('<div class="result wasm">');
            log('<strong>WASM - Bishop Attacks (with occupancy)</strong><br>');
            start = performance.now();
            for (let i = 0; i < iterations; i++) {
                bishop_attacks(square, occupancy);
            }
            const wasmBishopTime = performance.now() - start;
            log(`Time: ${wasmBishopTime.toFixed(2)}ms<br>`);
            log(`Ops/sec: ${(iterations / wasmBishopTime * 1000).toLocaleString()}</div>`);
            
            // Summary
            log('<h3>üìà Summary</h3>');
            log('<table>');
            log('<tr><th>Operation</th><th>JS Time</th><th>WASM Time</th><th>Result</th></tr>');
            
            const popcountClass = popcountSpeedup >= 1 ? 'speedup' : 'slowdown';
            const popcountText = popcountSpeedup >= 1 ? `${popcountSpeedup}x faster` : `${(1/popcountSpeedup).toFixed(2)}x slower`;
            log(`<tr><td>Popcount</td><td>${jsPopcountTime.toFixed(2)}ms</td><td>${wasmPopcountTime.toFixed(2)}ms</td><td class="${popcountClass}">${popcountText}</td></tr>`);
            
            const lsbClass = lsbSpeedup >= 1 ? 'speedup' : 'slowdown';
            const lsbText = lsbSpeedup >= 1 ? `${lsbSpeedup}x faster` : `${(1/lsbSpeedup).toFixed(2)}x slower`;
            log(`<tr><td>LSB</td><td>${jsLsbTime.toFixed(2)}ms</td><td>${wasmLsbTime.toFixed(2)}ms</td><td class="${lsbClass}">${lsbText}</td></tr>`);
            
            log(`<tr><td>Knight Attacks</td><td>-</td><td>${wasmKnightTime.toFixed(2)}ms</td><td>${(iterations / wasmKnightTime * 1000 / 1000000).toFixed(2)}M ops/s</td></tr>`);
            log(`<tr><td>Rook Attacks</td><td>-</td><td>${wasmRookTime.toFixed(2)}ms</td><td>${(iterations / wasmRookTime * 1000 / 1000000).toFixed(2)}M ops/s</td></tr>`);
            log(`<tr><td>Bishop Attacks</td><td>-</td><td>${wasmBishopTime.toFixed(2)}ms</td><td>${(iterations / wasmBishopTime * 1000 / 1000000).toFixed(2)}M ops/s</td></tr>`);
            log('</table>');
            
            if (popcountSpeedup >= 1) {
                log(`<div class="result winner">üí° <strong>Key Insight:</strong> WASM excels at ${popcountSpeedup}x speedup for complex bit operations like Popcount!</div>`);
            }
            log(`<div class="result">üìù <strong>Note:</strong> Simple operations like LSB may be faster in JS due to V8 optimizations and WASM call overhead.</div>`);
        }
    </script>
</body>
</html>
